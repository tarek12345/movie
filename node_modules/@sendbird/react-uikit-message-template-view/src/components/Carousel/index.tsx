import React, { type ForwardedRef, ReactElement } from 'react';

import { FlexSizeSpecValue, type MessageTemplateProps, defaultProperties } from '@sendbird/uikit-message-template';

import type { ReactParsedProperties } from '../../styles';
import { useCarousel } from './useCarousel';

interface CarouselProps {
  children: ReactElement<MessageTemplateProps>[];
  style?: ReactParsedProperties;
  spacing?: number;
  maxChildWidth?: number;
}
export const Carousel = ({
  children,
  style,
  spacing = defaultProperties.carousel.style.spacing,
  maxChildWidth = defaultProperties.carousel.style.maxChildWidth,
}: CarouselProps): ReactElement => {
  const { paddingInlineStart = 0, paddingInlineEnd = 0, ...restStyle } = style ?? {};
  const { carouselRef, childrenRefs, handlers } = useCarousel({
    spacing,
    childrenLength: children.length,
    paddingInlineStart: Number(paddingInlineStart),
    paddingInlineEnd: Number(paddingInlineEnd),
  });

  return (
    <div
      {...handlers}
      ref={carouselRef}
      className={'sb-message-template__carousel'}
      style={{ ...restStyle, gap: spacing, width: '100%', overflow: 'visible' }}
    >
      {children.map((item, index) => (
        <CarouselChild ref={childrenRefs.current[index]} key={index} maxChildWidth={maxChildWidth}>
          {item}
        </CarouselChild>
      ))}
    </div>
  );
};

interface CarouselChildProps {
  maxChildWidth: number;
  children: ReactElement<MessageTemplateProps>;
}
const CarouselChild = React.forwardRef(function CarouselChild(
  { maxChildWidth, children }: CarouselChildProps,
  ref: ForwardedRef<HTMLDivElement>,
) {
  const maxWidth = shouldSetMaxChildWidth(children.props, maxChildWidth) ? maxChildWidth : 'fit-content';

  return (
    <div ref={ref} style={{ maxWidth, width: '100%', flexShrink: 0, overflow: 'hidden', userSelect: 'none' }}>
      {children}
    </div>
  );
});

// Note: Set the maxChildWidth because it's impossible to determine the maximum width of items in the Carousel Child template when they have FillParent
function shouldSetMaxChildWidth(props: MessageTemplateProps, maxChildWidth: number) {
  return !!props.templateItems.find((it) => {
    const hasFillWidth = it.width?.type === 'flex' && it.width?.value === FlexSizeSpecValue.FillParent;
    const overMaxChildWidth = it.width?.type === 'fixed' && it.width?.value >= maxChildWidth;
    return hasFillWidth || overMaxChildWidth;
  });
}

export default Carousel;
